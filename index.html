<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nando Coins Pro | Dashboard</title>
    <style>
        :root {
            --gold: #DAA520; --dark-bg: #0a0a0a; --card-bg: #161616; --border: #333;
            --deus: #DAA520; --rubin: #a970ff; --green: #00e676; --red: #ff4b4b; --blue: #00d4ff;
        }
        
        body { background: var(--dark-bg); color: #e0e0e0; font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 15px; }
        .container { max-width: 1100px; margin: auto; }
        
        .header-main { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #222;
        }
        .header-main h1 { color: var(--gold); text-transform: uppercase; letter-spacing: 2px; margin: 0; font-size: 1.2rem; font-weight: 900; }

        .filter-bar { 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            background: #111; padding: 8px; border-radius: 8px; border: 1px solid #222; margin-bottom: 20px;
        }
        .filter-bar input { 
            background: transparent; border: 1px solid #333; color: #fff; font-size: 0.75rem; 
            padding: 4px; border-radius: 4px; color-scheme: dark; outline: none;
        }
        .btn-mini { 
            background: #222; border: 1px solid #333; color: #888; padding: 4px 8px; 
            font-size: 0.65rem; border-radius: 4px; cursor: pointer; text-transform: uppercase;
        }
        .btn-mini:hover { color: #fff; border-color: var(--gold); }
        .btn-mini.red { color: #ff4b4b; border-color: #441111; }

        .blur { filter: blur(10px); opacity: 0.2; pointer-events: none; }

        .grid-financeiro { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
        .card-f { background: var(--card-bg); border: 1px solid var(--border); padding: 12px; text-align: center; border-radius: 8px; }
        .card-f .label { font-size: 0.6rem; text-transform: uppercase; color: #666; margin-bottom: 4px; display: block; }
        .card-f .val { font-size: 1rem; font-weight: 800; }

        .grid-estoque { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .est-card { border-radius: 8px; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; background: #161616; border: 1px solid #333; border-left-width: 4px; }
        .est-card .amount { font-size: 1.2rem; font-weight: 900; }
        .est-medias { text-align: right; }
        .est-pm { font-size: 0.55rem; color: #555; display: block; margin-top: 1px; font-weight: bold; }

        .baixo-estoque { color: var(--red) !important; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .calc-section { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .calc-box { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .calc-header { padding: 8px 15px; background: #000; display: flex; justify-content: space-between; align-items: center; }
        .calc-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 12px; }
        .calc-sub { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; border: 1px solid #222; text-align: center; }
        
        .calc-sub label { display: block; font-size: 0.55rem; color: #666; text-transform: uppercase; margin-bottom: 3px; font-weight: bold; }
        
        input[type="number"] { 
            width: 100%; padding: 6px; background: #0a0a0a; border: 1px solid #333; 
            color: #fff; border-radius: 4px; text-align: center; font-weight: bold; font-size: 0.85rem; margin-bottom: 4px;
        }

        .btn-action { width: 100%; border: none; padding: 6px; border-radius: 4px; font-size: 0.6rem; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-c { background: #112233; color: var(--blue); border: 1px solid var(--blue); margin-top: 3px; }
        .btn-v { background: #113322; color: var(--green); border: 1px solid var(--green); margin-top: 3px; }
        .btn-r { background: #1a0a0a; color: #666; font-size: 0.5rem; padding: 2px 6px; border: 1px solid #333; }

        .lucro-k { display: block; font-size: 0.6rem; color: var(--gold); font-weight: bold; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.3); }

        .dashboard-tables { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .secao-tab { background: var(--card-bg); border: 1px solid var(--border); padding: 15px; border-radius: 8px; }
        .secao-tab h2 { font-size: 0.7rem; color: #555; text-transform: uppercase; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        td { padding: 8px; border-bottom: 1px solid #222; }

        @media (max-width: 800px) { .grid-financeiro { grid-template-columns: 1fr 1fr; } .calc-section { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header-main">
        <h1>üìä NANDO COINS</h1>
        <button class="btn-mini" onclick="togglePrivacy()">üëÅÔ∏è PRIVACIDADE</button>
    </div>

    <div class="filter-bar">
        <span style="font-size:0.6rem; color:#555; text-transform: uppercase; font-weight: bold;">Filtro:</span>
        <input type="date" id="dateStart" onchange="applyGlobalFilter()">
        <span style="color:#333">/</span>
        <input type="date" id="dateEnd" onchange="applyGlobalFilter()">
        <button class="btn-mini" onclick="setPeriod('today')">Hoje</button>
        <button class="btn-mini" onclick="setPeriod('week')">7D</button>
        <button class="btn-mini red" onclick="clearFilter()">Limpar</button>
    </div>

    <div class="grid-financeiro">
        <div class="card-f"><span class="label">Investido</span><span id="totalGasto" class="val" style="color:var(--red)">R$ 0</span></div>
        <div class="card-f"><span class="label">Recebido</span><span id="totalRecebido" class="val" style="color:var(--green)">R$ 0</span></div>
        <div class="card-f"><span class="label">Lucro</span><span id="lucroTotal" class="val" style="color:var(--gold)">R$ 0</span></div>
        <div class="card-f"><span class="label">Coins Compradas</span><span id="coinsCompradas" class="val">0</span></div>
        <div class="card-f"><span class="label">Coins Vendidas</span><span id="coinsVendidas" class="val">0</span></div>
    </div>

    <div class="grid-estoque">
        <div class="est-card" style="border-left-color: var(--deus);">
            <div style="flex-grow:1"><span style="font-size:0.7rem; font-weight:bold; color:var(--deus)">DEUSOT</span></div>
            <div class="est-medias">
                <span id="estDeus" class="amount">0</span>
                <span id="pmCDeus" class="est-pm">M√©dia R$ Compra: R$ 0,00</span>
                <span id="pmVDeus" class="est-pm">M√©dia R$ Venda: R$ 0,00</span>
            </div>
        </div>
        <div class="est-card" style="border-left-color: var(--rubin);">
            <div style="flex-grow:1"><span style="font-size:0.7rem; font-weight:bold; color:var(--rubin)">RUBINOT</span></div>
            <div class="est-medias">
                <span id="estRubin" class="amount">0</span>
                <span id="pmCRubin" class="est-pm">M√©dia R$ Compra: R$ 0,00</span>
                <span id="pmVRubin" class="est-pm">M√©dia R$ Venda: R$ 0,00</span>
            </div>
        </div>
    </div>

    <div class="calc-section">
        <div class="calc-box">
            <div class="calc-header">
                <span style="font-size:0.7rem; font-weight:900; color:var(--deus)">DEUSOT</span>
                <span id="lucroKDeus" class="lucro-k">LUCRO: R$ 0.00/1k</span>
                <button class="btn-r" onclick="resetCalc('Deus')">RESET</button>
            </div>
            <div class="calc-group">
                <div class="calc-sub">
                    <label>üõí Compra 1k</label>
                    <input type="number" id="buyUnitDeus" value="70.00" oninput="calculate('Deus', 'Q')">
                    <label>Coins</label>
                    <input type="number" id="buyQtyDeus" placeholder="0" oninput="calculate('Deus', 'Q')">
                    <label>Total R$</label>
                    <input type="number" id="buyTotalDeus" placeholder="0.00" oninput="calculate('Deus', 'V')">
                    <button class="btn-action btn-c" onclick="copyQuote('Deus', 'compra')">COPIAR COMPRA</button>
                </div>
                <div class="calc-sub">
                    <label>üí∞ Venda 1k</label>
                    <input type="number" id="saleUnitDeus" value="79.00" oninput="calculate('Deus', 'Q')">
                    <label>Coins</label>
                    <input type="number" id="saleQtyDeus" placeholder="0" oninput="calculate('Deus', 'Q')">
                    <label>Receber R$</label>
                    <input type="number" id="saleTotalDeus" placeholder="0.00" oninput="calculate('Deus', 'V')">
                    <button class="btn-action btn-v" onclick="copyQuote('Deus', 'venda')">COPIAR VENDA</button>
                </div>
            </div>
        </div>

        <div class="calc-box">
            <div class="calc-header">
                <span style="font-size:0.7rem; font-weight:900; color:var(--rubin)">RUBINOT</span>
                <span id="lucroKRubin" class="lucro-k">LUCRO: R$ 0.00/1k</span>
                <button class="btn-r" onclick="resetCalc('Rubin')">RESET</button>
            </div>
            <div class="calc-group">
                <div class="calc-sub">
                    <label>üõí Compra 1k</label>
                    <input type="number" id="buyUnitRubin" value="81.00" oninput="calculate('Rubin', 'Q')">
                    <label>Coins</label>
                    <input type="number" id="buyQtyRubin" placeholder="0" oninput="calculate('Rubin', 'Q')">
                    <label>Total R$</label>
                    <input type="number" id="buyTotalRubin" placeholder="0.00" oninput="calculate('Rubin', 'V')">
                    <button class="btn-action btn-c" onclick="copyQuote('Rubin', 'compra')">COPIAR COMPRA</button>
                </div>
                <div class="calc-sub">
                    <label>üí∞ Venda 1k</label>
                    <input type="number" id="saleUnitRubin" value="85.00" oninput="calculate('Rubin', 'Q')">
                    <label>Coins</label>
                    <input type="number" id="saleQtyRubin" placeholder="0" oninput="calculate('Rubin', 'Q')">
                    <label>Receber R$</label>
                    <input type="number" id="saleTotalRubin" placeholder="0.00" oninput="calculate('Rubin', 'V')">
                    <button class="btn-action btn-v" onclick="copyQuote('Rubin', 'venda')">COPIAR VENDA</button>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-tables">
        <div class="secao-tab"><h2>COMPRAS</h2><table id="tabCompras"><tbody></tbody></table></div>
        <div class="secao-tab"><h2>VENDAS</h2><table id="tabVendas"><tbody></tbody></table></div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzWNrfNxxFw5qlG5UITgyN8LYhBUAGFipSaRaFLxzW5xF5rBTuY5fJnflshDunjCN2D3g/exec";
    const defaults = { Deus: { buy: 70, sale: 79 }, Rubin: { buy: 81, sale: 85 } };
    let DATA_MASTER = null;

    async function load() {
        try {
            const res = await fetch(API_URL);
            DATA_MASTER = await res.json();
            // Removido o filtro autom√°tico de hoje para exibir o total acumulado ao abrir
            applyGlobalFilter();
        } catch (e) { console.error(e); }
    }

    function setPeriod(mode) {
        const s = document.getElementById('dateStart');
        const e = document.getElementById('dateEnd');
        const today = new Date().toISOString().split('T')[0];
        e.value = today;
        if (mode === 'today') s.value = today;
        else { let d = new Date(); d.setDate(d.getDate()-7); s.value = d.toISOString().split('T')[0]; }
        applyGlobalFilter();
    }

    function clearFilter() {
        document.getElementById('dateStart').value = "";
        document.getElementById('dateEnd').value = "";
        applyGlobalFilter();
    }

    function applyGlobalFilter() {
        if (!DATA_MASTER) return;
        const start = document.getElementById('dateStart').value;
        const end = document.getElementById('dateEnd').value;
        
        const filtrar = (l) => l.filter(i => {
            const d = i.data.split('T')[0];
            return (!start || d >= start) && (!end || d <= end);
        });

        const cF = filtrar(DATA_MASTER.compras);
        const vF = filtrar(DATA_MASTER.vendas);
        let inv=0, rec=0, gC=0, gV=0;
        cF.forEach(c => { inv += parseFloat(c.total_pago); gC += parseFloat(c.quantidade); });
        vF.forEach(v => { rec += parseFloat(v.total_recebido); gV += parseFloat(v.quantidade); });

        document.getElementById('totalGasto').innerText = inv.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 });
        document.getElementById('totalRecebido').innerText = rec.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 });
        document.getElementById('lucroTotal').innerText = (rec - inv).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 });
        document.getElementById('coinsCompradas').innerText = gC.toLocaleString('pt-BR');
        document.getElementById('coinsVendidas').innerText = gV.toLocaleString('pt-BR');

        DATA_MASTER.resumo.forEach(r => {
            const serv = r.servidor.toLowerCase().includes("deus") ? "Deus" : "Rubin";
            const val = parseFloat(r.estoque_atual);
            const el = document.getElementById('est' + serv);
            el.innerText = val.toLocaleString('pt-BR');
            el.classList.toggle('baixo-estoque', val < 2000);
            
            const comprasMaster = DATA_MASTER.compras.filter(c => c.servidor.toLowerCase().includes(serv.toLowerCase()));
            const totalPago = comprasMaster.reduce((acc, c) => acc + parseFloat(c.total_pago), 0);
            const totalQtdC = comprasMaster.reduce((acc, c) => acc + parseFloat(c.quantidade), 0);
            const mediaC = totalQtdC > 0 ? (totalPago / totalQtdC * 1000) : 0;
            document.getElementById('pmC' + serv).innerText = `M√©dia R$ Compra: R$ ${mediaC.toFixed(3)}`;

            const vendasMaster = DATA_MASTER.vendas.filter(v => v.servidor.toLowerCase().includes(serv.toLowerCase()));
            const totalRec = vendasMaster.reduce((acc, v) => acc + parseFloat(v.total_recebido), 0);
            const totalQtdV = vendasMaster.reduce((acc, v) => acc + parseFloat(v.quantidade), 0);
            const mediaV = totalQtdV > 0 ? (totalRec / totalQtdV * 1000) : 0;
            document.getElementById('pmV' + serv).innerText = `M√©dia R$ Venda: R$ ${mediaV.toFixed(3)}`;
        });

        const row = (i, f) => {
            const sName = i.servidor.toLowerCase().includes('deus') ? 'DeusOT' : 'RubinOT';
            const qty = parseFloat(i.quantidade);
            const displayQty = qty < 1000 ? qty.toString() : (qty / 1000).toFixed(1) + 'k';
            return `<tr><td style="color:#444;font-size:0.6rem">${i.data.split('T')[0].slice(5)}</td><td style="font-weight:bold;color:${i.servidor.toLowerCase().includes('deus')?'var(--deus)':'var(--rubin)'}">${sName}</td><td class="val">${displayQty}</td><td class="val">R$${parseFloat(i[f]).toFixed(0)}</td></tr>`;
        };
        document.querySelector("#tabCompras tbody").innerHTML = cF.slice(0, 8).map(c => row(c, 'total_pago')).join('');
        document.querySelector("#tabVendas tbody").innerHTML = vF.slice(0, 8).map(v => row(v, 'total_recebido')).join('');
        
        calculate('Deus', 'Q'); calculate('Rubin', 'Q');
    }

    function calculate(s, modo) {
        const bUnit = parseFloat(document.getElementById('buyUnit' + s).value) || 0;
        const sUnit = parseFloat(document.getElementById('saleUnit' + s).value) || 0;
        const bQtyInput = document.getElementById('buyQty' + s);
        const bValInput = document.getElementById('buyTotal' + s);
        const sQtyInput = document.getElementById('saleQty' + s);
        const sValInput = document.getElementById('saleTotal' + s);

        const lucroK = (sUnit - bUnit).toFixed(2);
        const elLucro = document.getElementById('lucroK' + s);
        elLucro.innerText = `LUCRO: R$ ${lucroK}/1k`;
        if (lucroK >= 8) elLucro.style.color = 'var(--green)';
        else if (lucroK >= 4) elLucro.style.color = 'var(--gold)';
        else elLucro.style.color = 'var(--red)';

        if (modo === 'Q') {
            bValInput.value = (parseFloat(bQtyInput.value) / 1000 * bUnit).toFixed(2);
            sValInput.value = (parseFloat(sQtyInput.value) / 1000 * sUnit).toFixed(2);
        } else {
            if (bUnit > 0) {
                let qtyB = Math.floor((parseFloat(bValInput.value) / bUnit * 1000) / 25) * 25;
                bQtyInput.value = qtyB;
                bValInput.dataset.real = (qtyB / 1000 * bUnit).toFixed(2);
            }
            if (sUnit > 0) {
                let qtyS = Math.floor((parseFloat(sValInput.value) / sUnit * 1000) / 25) * 25;
                sQtyInput.value = qtyS;
                sValInput.dataset.real = (qtyS / 1000 * sUnit).toFixed(2);
            }
        }
    }

    ['buyTotalDeus', 'saleTotalDeus', 'buyTotalRubin', 'saleTotalRubin'].forEach(id => {
        document.getElementById(id).addEventListener('blur', function() {
            if (this.dataset.real) this.value = this.dataset.real;
        });
    });
    
    function copyQuote(s, tipo) {
        const isVendaParaCliente = tipo === 'venda';
        const q = document.getElementById((isVendaParaCliente ? 'sale' : 'buy') + 'Qty' + s).value;
        const v = document.getElementById((isVendaParaCliente ? 'sale' : 'buy') + 'Total' + s).value;
        if(!q || !v) return;
        const titulo = isVendaParaCliente ? `üìä *Simula√ß√£o para voc√™ COMPRAR coins*` : `üìä *Simula√ß√£o para voc√™ VENDER coins*`;
        const msg = `${titulo}\n\nüíé Qtd: ${parseFloat(q).toLocaleString('pt-BR')} Coins\nüí∞ Valor Total: R$ ${v}`;
        navigator.clipboard.writeText(msg).then(() => alert("Copiado!"));
    }

    function resetCalc(s) {
        document.getElementById('buyUnit'+s).value = defaults[s].buy.toFixed(2);
        document.getElementById('saleUnit'+s).value = defaults[s].sale.toFixed(2);
        ['buyQty', 'buyTotal', 'saleQty', 'saleTotal'].forEach(id => {
            const el = document.getElementById(id + s);
            el.value = "";
            delete el.dataset.real;
        });
        calculate(s, 'Q');
    }

    function togglePrivacy() { document.querySelectorAll('.val, .amount, .est-pm').forEach(el => el.classList.toggle('blur')); }

    load();
    setInterval(load, 60000);
</script>
</body>
</html>